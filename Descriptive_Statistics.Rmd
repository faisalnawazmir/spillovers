---
title: Deskriptivní statistiky časových řad
author: Daniel Bartušek
output: html_document

knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
---
```{r include = F}
rm(list = ls())
options(scipen = 100, digits = 8)
knitr::opts_chunk$set(warning=FALSE)
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(echo = TRUE)
quiet <- function(x) { 
  sink(tempfile()) 
  on.exit(sink()) 
  invisible(force(x)) 
}
```

```{r }
library(dplyr)
library(ggplot2)
library(reshape2)
library(dse)
library(readxl)
library(ggpubr)
library(corrplot)
library(kableExtra)
library(stargazer)
library(tseries)
library(tidyverse)
library(moments)
library(fGarch)
library(lmtest)
library(stringr)
library(printr)
library(frequencyConnectedness)
library(imputeTS)
```

```{r lagpad, echo = F}
# lag function
lagpad <- function(x, k = 1) {
  i <- is.vector(x)
  if (is.vector(x)) x <- matrix(x) else x <- matrix(x, nrow(x))
  if (k > 0) {
    x <- rbind(matrix(rep(NA, k * ncol(x)), ncol = ncol(x)), matrix(x[1:(nrow(x) - k), ], ncol = ncol(x)))
  } else {
    x <- rbind(matrix(x[(-k + 1):(nrow(x)), ], ncol = ncol(x)), matrix(rep(NA, -k * ncol(x)), ncol = ncol(x)))
  }
  if (i) x[1:length(x)] else x
}
```

## Load data

```{r load_data}
stylized_names <-c("Natural Gas","Crude Oil WTI","NY Gasoline","Gulf Gasoline","Heating Oil","Diesel")

nat_gas_spot <- read_excel("data/NG_PRI_FUT_S1_D.xls", sheet = "Data 1", skip = 2) %>%
  rename("Natural_Gas" = 2)
crude_oil_spot <- read_excel("data/PET_PRI_SPT_S1_D.xls", sheet = "Data 1", skip = 2) %>%
  rename("Crude_Oil_WTI" = 2, "Crude_Oil_Europe_Brent" = 3)
gasoline <- read_excel("data/PET_PRI_SPT_S1_D.xls", sheet = "Data 2", skip = 2) %>%
  rename("NY_Gasoline" = 2, "Gulf_Gasoline" = 3)
heating_oil <- read_excel("data/PET_PRI_SPT_S1_D.xls", sheet = "Data 4", skip = 2) %>%
  rename("Heating_Oil" = 2)
diesel <- read_excel("data/PET_PRI_SPT_S1_D.xls", sheet = "Data 5", skip = 2) %>%
  dplyr::select(-2, -3) %>%
  rename("Diesel" = 2)

df <- nat_gas_spot %>%
  full_join(crude_oil_spot, by = "Date") %>%
  full_join(gasoline, by = "Date") %>%
  full_join(heating_oil, by = "Date") %>%
  full_join(diesel, by = "Date") %>%
  arrange(Date) %>%
  dplyr::filter(Date >= "1997-01-07") %>%
  mutate(Date=as.Date(Date),
         Day = weekdays(Date)) %>%
  dplyr::select(1,9,2:8)

head(df) %>% 
  kbl() %>%
  kable_classic_2(full_width = F)
```

```{r ts, include=F, eval=F}
nat_gas_spot_ts <- xts(nat_gas_spot$Natural_Gas, frequency = 365, order.by = as.Date(nat_gas_spot$Date))
crude_oil_spot <- ts(crude_oil_spot[, 1:2], frequency = 7, start = as.Date("1997-01-07"), end = as.Date("2021-07-01"))
NY_Gasoline_ts <- ts(gasoline[, c(1, 2)], start = as.Date("1997-01-07"))
Gulf_Gasoline_ts <- ts(gasoline[, c(1, 3)], start = as.Date("1997-01-07"))
heating_oil_ts <- ts(heating_oil, start = as.Date("1997-01-07"))
diesel_ts <- ts(diesel, start = as.Date("1997-01-07"))
ts_list <- list(nat_gas_spot_ts, crude_oil_spot, NY_Gasoline_ts, Gulf_Gasoline_ts, heating_oil_ts, diesel_ts)

attr(nat_gas_spot_ts, "frequency") <- 7
nat_gas_spot_ts <- na.omit(nat_gas_spot_ts)
plot(decompose(as.ts(nat_gas_spot_ts)))

#Dont know hot to use this decomposition, but might be a useful tool in the future.
```



### Removing NAs

```{r NAs, echo = F}
print("Sum on NAs in each column")
colSums(is.na(df))%>%
    kbl(col.names="NAs") %>%
  kable_classic_2(full_width = F)
print("Sample of uncomplete data")
aux <- df[!complete.cases(df), ]
head(aux) %>% 
  rbind(aux%>%dplyr::filter(Day=="Sunday"))%>%
  kbl() %>%
  kable_classic_2(full_width = F)
print("NA occurrences per weekday: no particular pattern in weekdays, although most reported on Monday")
table(aux$Day)
```

We see that our data contains some NAs. There are multiple reasons for it:

* In the month of March 2020, Natural_Gas values have been reported on Sunday
* Europe Brent crude oil benchmark is reported on days where the others are not. There might be a way to compute one from the other, so that we could use a union of the two, but for the time being, we will only use the WTI crude oil metric.
* The first column "Natural_Gas" comes from a separate dataset than the rest of the variables, resulting in approximately 25 days where only Natural_Gas has been reported, and 15 rows where all but Natural_Gas has been reported. The former has no pattern other than a monthly occurrence. The latter happened in two consecutive weeks in September 2005. 

These NAs are listed in the table below. Apart from the NAs explained above, there are roughly 10 unexplained NAs remaining. 

It might be best to treat the first and second data source as separate, but there is only a few NAs remaining, so for this purpose, we simply substitute with mean. Could also substitute with the rolling average.


```{r na_treating1, echo = F}
aux2<-aux %>% dplyr::select(-Crude_Oil_Europe_Brent) %>% dplyr::filter(Day != "Sunday") # treating the first 2 sources of NAs
NA_dates <- aux2 %>%
  filter_at(vars(-c(Date,Day)), all_vars(is.na(.))) %>%
  pull(Date)

aux2<-aux2%>% dplyr::filter(!Date %in% NA_dates)
aux3<-aux2[!complete.cases(aux2), ]
aux3%>%
  kbl() %>%
  kable_classic_2(full_width = F)
```

```{r na_treating_main}
df <- df %>% dplyr::select(-Crude_Oil_Europe_Brent) %>% dplyr::filter(Day != "Sunday")
NA_dates <- df %>%
  filter_at(vars(-c(Date,Day)), all_vars(is.na(.))) %>%
  pull(Date)
df <- df %>% dplyr::filter(!Date %in% NA_dates)

for(i in 3:length(df)){
  df[,i]<-imputeTS::na_ma(df[,i], k = 10, weighting = "simple")
}
```



### Prices
```{r prices_stats}
long_df <- reshape2::melt(df, id.vars = c("Date","Day"))

ggplot(long_df, aes(x = Date, y = value)) +
  geom_line() +
  facet_wrap(~variable, scales = "free") +
  ggtitle("Prices") +
  geom_vline(xintercept = as.POSIXct("2008-9-15"), color = "Red")

ggplot(long_df, aes(factor(variable), value)) + 
geom_boxplot() + 
facet_wrap(~variable, scale="free")
```


We see that this **crude oil WTI metric** had negative prices at one point. This would not let us do log-returns, so we substitute with low value for now. Should be treated more rigorously later on.

```{r crude_oil_sub}
df[df$Date=="2020-04-20","Crude_Oil_WTI"]<-0.01
```

### Log returns

```{r log_ret}
log_ret_df <- tibble(df[2:nrow(df), "Date"])

for (i in 3:(ncol(df))) {
  var_name <- paste(colnames(df)[i], "log_ret", sep = "_")
  vals <- log(df[, i]) %>% pull()
  lag_vals <- base::diff(vals, lag = 1)
  log_ret_df[var_name] <- lag_vals
}
long_log_ret <- melt(log_ret_df, id.vars = "Date")
```


```{r corplot_logret}
cor_long_df <- cor(log_ret_df[,-1])
corrplot(cor_long_df, type="upper", order="hclust", tl.col="black", tl.srt=45,
         col = COL2('PiYG'), cl.pos = 'b', addCoef.col = 'black')
```


```{r log_ret_plot}
ggplot(long_log_ret, aes(x = Date, y = value)) +
  geom_line() +
  facet_wrap(~variable, scales = "free") +
  ggtitle("Log Returns - May be stationary")
```


```{r summary_table_draft, echo = F}

summary_df<-long_log_ret %>% group_by(as.factor(variable)) %>%
  get_summary_stats(type = "common") %>%dplyr::select(-variable,n) %>% 
  rename("variable" = 1)%>%
  data.table::transpose( keep.names = "col",make.names = "variable")
rownames(summary_df)<-summary_df[,1]
summary_df<-summary_df[-1]


summary_df[c("skewness", "kurtosis"),] <- rbind(c(round(sapply(log_ret_df[c(2:7)],skewness),3),
                                                  round(sapply(log_ret_df[c(2:7)],kurtosis),3)))
colnames(summary_df) <- stylized_names
```

## Summary and Statistical Tests
```{r test_prep, echo = T}
ar_1_list <- list()
q_10_list<- list()
q2_10_list<- list()
ma_1_list <- list()
arch_5_list<-list()
shapiro_norm_list<-list()
adf_list<-list()
jarque_bera_list<-list()

for(i in 2:length(log_ret_df)){
  val<-log_ret_df[,i] %>% pull()
  res<-lm(val~I(lagpad(val, 1)))$residuals
  shapiro_norm_list[[i-1]]<-shapiro.test(sample(val,size=5000,replace = F))
  adf_list[[i-1]] <- adf.test(val)
  ma_1_list[[i-1]] <- arima(val, order = c(0, 0, 1)) 
  ar_1_list[[i-1]] <- arima( res, order = c(1, 0, 0))
  q_10_list[[i-1]]<-Box.test(res, lag = 10, type =  "Ljung-Box")
  q2_10_list[[i-1]]<-Box.test(res^2, lag = 10, type =  "Ljung-Box")
  arch_5_list[[i-1]]<- quiet(garch(res,c(0,5)))
  jarque_bera_list[[i-1]]<-jarque.bera.test(val)
}

```


```{r all_tests, echo = F}
res_matrix<-data.frame(matrix(ncol=6,nrow=14))
x <- c("name", "age", "gender")
colnames(res_matrix) <- stylized_names
rownames(res_matrix)<-c("Shapiro Normality","Shapiro Normality PVal","ADF","ADF Pval","Q(10)","Q(10) Pval","Q2(10)","Q2(10) Pval","ARCH(5)","ARCH(5) Pval","AR(1)","AR(1) Pval","Jarque-Berra","Jarque Berra Pval")

for (i in 1:length(stylized_names)){
  res_matrix[1,i]<-round(shapiro_norm_list[[i]]$statistic,2)
  res_matrix[2,i]<-shapiro_norm_list[[i]]$p.value
  res_matrix[3,i]<-round(adf_list[[i]]$statistic,2)
  res_matrix[4,i]<-adf_list[[i]]$p.value
  res_matrix[5,i]<-round(q_10_list[[i]]$statistic,2)
  res_matrix[6,i]<-q_10_list[[i]]$p.value
  res_matrix[7,i]<-round(q2_10_list[[i]]$statistic,2)
  res_matrix[8,i]<-q2_10_list[[i]]$p.value
  arch_res<-coeftest(arch_5_list[[i]])
  res_matrix[9,i]<-round(arch_res[6,1],3)
  res_matrix[10,i]<-arch_res[6,4]
  ar_res<-coeftest(ar_1_list[[i]])
  res_matrix[11,i]<-round(ar_res[1,1],3)
  res_matrix[12,i]<-ar_res[1,4]
  res_matrix[13,i]<-round(jarque_bera_list[[i]]$statistic,3)
  res_matrix[14,i]<-jarque_bera_list[[i]]$p.value
}

for (i in 1:length(res_matrix)){
  row <- as.character(res_matrix[,i])
  for (j in seq(from = 1, to = length(row)-1,by = 2)){
    coef<-round(as.numeric(row[j]),4)
    pval<-as.numeric(row[j+1])
    row[j]<-ifelse(pval<=0.001,paste(coef,"***",sep=""),
                   ifelse(pval<=0.01,paste(coef,"**",sep=""),
                          ifelse(pval<=0.05,paste(coef,"*",sep=""),as.character(coef))))
    row[j+1]<-as.character(round(pval,5))
  }
  res_matrix[,i]<-row
}

final_df<-summary_df %>% rbind(res_matrix)

final_kbl<-final_df%>%
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

final_kbl
```

```{r spillovers spec}
sp_list<-lsf.str("package:frequencyConnectedness")
sp_list<-sp_list[str_detect(sp_list,"spill")]
print(sp_list)
help(sp_list[1])
```


```{r DY_2009}
log_ret_df<-log_ret_df[-1] #no date
est <- VAR(log_ret_df, p = 2, type = "const")
sp<-spilloverDY09(est, n.ahead = 100, no.corr = F)
```

```{r sp_graphs}
overall(sp)
to(sp)
from(sp)
net(sp)
pairwise(sp)
```

```{r rolling_plots}
# Get the rolling window estimates
params_est = list(p = 2, type = "const")
sp <- spilloverRollingDY09(log_ret_df[-1], n.ahead = 100, no.corr = F, "VAR", params_est = params_est, window = 100)
plotOverall(sp)
plotTo(sp)
plotFrom(sp)
```


