---
title: Deskriptivní statistiky časových řad
author: Daniel Bartušek
output: html_document

knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
---
```{r include = F}
rm(list = ls())
options(scipen = 100, digits = 8)
knitr::opts_chunk$set(warning=FALSE)
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(echo = TRUE)
```

```{r }
library(dplyr)
library(ggplot2)
library(reshape2)
library(dse)
library(readxl)
library(ggpubr)
library(corrplot)
library(kableExtra)
library(stargazer)
library(tseries)
library(tidyverse)
```

```{r lagpad, echo = F}
# lag function
lagpad <- function(x, k = 1) {
  i <- is.vector(x)
  if (is.vector(x)) x <- matrix(x) else x <- matrix(x, nrow(x))
  if (k > 0) {
    x <- rbind(matrix(rep(NA, k * ncol(x)), ncol = ncol(x)), matrix(x[1:(nrow(x) - k), ], ncol = ncol(x)))
  } else {
    x <- rbind(matrix(x[(-k + 1):(nrow(x)), ], ncol = ncol(x)), matrix(rep(NA, -k * ncol(x)), ncol = ncol(x)))
  }
  if (i) x[1:length(x)] else x
}
```

## Load data

```{r load_data}
nat_gas_spot <- read_excel("data/NG_PRI_FUT_S1_D.xls", sheet = "Data 1", skip = 2) %>%
  rename("Natural_Gas" = 2)
crude_oil_spot <- read_excel("data/PET_PRI_SPT_S1_D.xls", sheet = "Data 1", skip = 2) %>%
  rename("Crude_Oil_WTI" = 2, "Crude_Oil_Europe_Brent" = 3)
gasoline <- read_excel("data/PET_PRI_SPT_S1_D.xls", sheet = "Data 2", skip = 2) %>%
  rename("NY_Gasoline" = 2, "Gulf_Gasoline" = 3)
heating_oil <- read_excel("data/PET_PRI_SPT_S1_D.xls", sheet = "Data 4", skip = 2) %>%
  rename("Heating_Oil" = 2)
diesel <- read_excel("data/PET_PRI_SPT_S1_D.xls", sheet = "Data 5", skip = 2) %>%
  select(-2, -3) %>%
  rename("Diesel" = 2)

dt <- nat_gas_spot %>%
  full_join(crude_oil_spot, by = "Date") %>%
  full_join(gasoline, by = "Date") %>%
  full_join(heating_oil, by = "Date") %>%
  full_join(diesel, by = "Date") %>%
  arrange(Date) %>%
  filter(Date >= "1997-01-07") %>%
  mutate(Date=as.Date(Date),
         Day = weekdays(Date)) %>%
  select(1,9,2:8)

head(dt) %>% 
  kbl() %>%
  kable_classic_2(full_width = F)
```

```{r ts, include=F, eval=F}
nat_gas_spot_ts <- xts(nat_gas_spot$Natural_Gas, frequency = 365, order.by = as.Date(nat_gas_spot$Date))
crude_oil_spot <- ts(crude_oil_spot[, 1:2], frequency = 7, start = as.Date("1997-01-07"), end = as.Date("2021-07-01"))
NY_Gasoline_ts <- ts(gasoline[, c(1, 2)], start = as.Date("1997-01-07"))
Gulf_Gasoline_ts <- ts(gasoline[, c(1, 3)], start = as.Date("1997-01-07"))
heating_oil_ts <- ts(heating_oil, start = as.Date("1997-01-07"))
diesel_ts <- ts(diesel, start = as.Date("1997-01-07"))
ts_list <- list(nat_gas_spot_ts, crude_oil_spot, NY_Gasoline_ts, Gulf_Gasoline_ts, heating_oil_ts, diesel_ts)

attr(nat_gas_spot_ts, "frequency") <- 7
nat_gas_spot_ts <- na.omit(nat_gas_spot_ts)
plot(decompose(as.ts(nat_gas_spot_ts)))

#Dont know hot to use this decomposition, but might be a useful tool in the future.
```



### Removing NAs

```{r NAs, echo = F}
print("Sum on NAs in each column")
colSums(is.na(dt))%>%
    kbl(col.names="NAs") %>%
  kable_classic_2(full_width = F)
print("Sample of uncomplete data")
aux <- dt[!complete.cases(dt), ]
head(aux) %>% 
  rbind(aux%>%filter(Day=="Sunday"))%>%
  kbl() %>%
  kable_classic_2(full_width = F)
print("NA occurrences per weekday: no particular pattern in weekdays, although most reported on Monday")
table(aux$Day)
```

We see that our data contains some NAs. There are multiple reasons for it:

* In the month of March 2020, Natural_Gas values have been reported on Sunday
* Europe Brent crude oil benchmark is reported on days where the others are not. There might be a way to compute one from the other, so that we could use a union of the two, but for the time being, we will only use the WTI crude oil metric.
* The first column "Natural_Gas" comes from a separate dataset than the rest of the variables, resulting in approximately 25 days where only Natural_Gas has been reported, and 15 rows where all but Natural_Gas has been reported. The former has no pattern other than a monthly occurrence. The latter happened in two consecutive weeks in September 2005. 

These NAs are listed in the table below. Apart from the NAs explained above, there are roughly 10 unexplained NAs remaining. 

It might be best to treat the first and second data source as separate, but there is only a few NAs remaining, so for this purpose, we simply substitute with mean. Could also substitute with the rolling average.


```{r na_treating1, echo = F}
aux2<-aux %>% select(-Crude_Oil_Europe_Brent) %>% filter(Day != "Sunday") # treating the first 2 sources of NA
NA_dates <- aux2 %>%
  filter_at(vars(-c(Date,Day)), all_vars(is.na(.))) %>%
  pull(Date)

aux2<-aux2%>% filter(!Date %in% NA_dates)
aux3<-aux2[!complete.cases(aux2), ]
aux3%>%
  kbl() %>%
  kable_classic_2(full_width = F)
```

```{r na_treating_main}
dt <- dt %>% select(-Crude_Oil_Europe_Brent) %>% filter(Day != "Sunday")
NA_dates <- dt %>%
  filter_at(vars(-c(Date,Day)), all_vars(is.na(.))) %>%
  pull(Date)
dt <- dt %>% filter(!Date %in% NA_dates)
dt <- dt %>% mutate_all(~ replace(., is.na(.), mean(., na.rm = TRUE)))
```



### Summary statistics - Prices

```{r prices_stats}
long_dt <- melt(dt, id.vars = c("Date","Day"))

ggplot(long_dt, aes(factor(variable), value)) + 
geom_boxplot() + 
facet_wrap(~variable, scale="free")

long_dt %>% group_by(as.factor(variable)) %>%
  get_summary_stats(type = "common")%>%
  kbl() %>%
  kable_classic_2(full_width = F)

```

We see that this **crude oil WTI metric** had negative prices at one point. This would not let us do log-returns, so we substitute with low value for now. Should be treated more rigorously later on.

```{r crude_oil_sub}
dt[dt$Date=="2020-04-20","Crude_Oil_WTI"]<-0.01
```

### Log returns

```{r}
log_ret_dt <- tibble(dt[2:nrow(dt), "Date"])

for (i in 3:(ncol(dt))) {
  var_name <- paste(colnames(dt)[i], "log_ret", sep = "_")
  vals <- log(dt[, i]) %>% pull()
  lag_vals <- diff(vals, lag = 1)
  log_ret_dt[var_name] <- lag_vals
}

```

### Summary statistics - Log Returns

```{r log_ret_stats}
long_log_ret <- melt(log_ret_dt, id.vars = "Date")

ggplot(long_log_ret, aes(factor(variable), value)) + 
geom_boxplot() + 
facet_wrap(~variable, scale="free")

long_log_ret %>% group_by(as.factor(variable)) %>%
  get_summary_stats(type = "common")%>%
    kbl() %>%
  kable_classic_2(full_width = F)

```

```{r corplot_logret}
cor_long_dt <- cor(log_ret_dt[,-1])
corrplot(cor_long_dt, type="upper", order="hclust", tl.col="black", tl.srt=45,
         col = COL2('PiYG'), cl.pos = 'b', addCoef.col = 'black')
```

### Basic plots

```{r price_plot}
ggplot(long_dt, aes(x = Date, y = value)) +
  geom_line() +
  facet_wrap(~variable, scales = "free") +
  theme(axis.text.x = element_blank()) +
  ggtitle("Prices") +
  geom_vline(xintercept = as.POSIXct("2008-9-15"), color = "Red")
```

Everything but Natural gas looks very correlated, price data are obviously not stationary, so we transform to log-returns.

```{r log_ret_plot}
ggplot(long_log_ret, aes(x = Date, y = value)) +
  geom_line() +
  facet_wrap(~variable, scales = "free") +
  theme(axis.text.x = element_blank()) +
  ggtitle("Log Returns - May be stationary")
```

## Statistical Tests

### Autocorrelation tests

```{r natgas,echo = F}
#Natural Gas
model <- lm(Natural_Gas_log_ret ~ I(lagpad(Natural_Gas_log_ret, 1)), data = log_ret_dt)
res <- summary(model)$residuals
ar_lm_nat_gas <- lm(res ~ lagpad(res, 1))
```
```{r adf_natgas}
adf.test(log_ret_dt$Natural_Gas_log_ret) #no unit root
```

```{r natgas_res,echo=TRUE,results='asis'}
stargazer(ar_lm_nat_gas, header=FALSE,type="html") #no autocorrelation of residuals
```

```{r crd,echo = F}
#Crude Oil
model <- lm(Crude_Oil_WTI_log_ret ~ I(lagpad(Crude_Oil_WTI_log_ret, 1)), data = log_ret_dt)
res <- summary(model)$residuals
ar_lm_crd_oil<- lm(res ~ lagpad(res, 1))
```

```{r crd_adf}
adf.test(log_ret_dt$Crude_Oil_WTI_log_ret) # no unit root
```

```{r crd_res,echo=TRUE,results='asis'}
stargazer(ar_lm_crd_oil, header=FALSE,type="html")  #AR(1) OF RESIDUALS
```


```{r NY_gas,echo = F}
#NY Gasoline
model <- lm(NY_Gasoline_log_ret ~ I(lagpad(NY_Gasoline_log_ret, 1)), data = log_ret_dt)
res <- summary(model)$residuals
ar_lm_gasoline<- lm(res ~ lagpad(res, 1))
```

```{r NY_gas_adf}
adf.test(log_ret_dt$NY_Gasoline_log_ret) # no unit root
```

```{r NY_gas_res,echo=TRUE,results='asis'}
stargazer(ar_lm_gasoline, header=FALSE,type="html")  #AR(1) OF RESIDUALS
```

```{r gulf_gas,echo = F}
model <- lm(Gulf_Gasoline_log_ret ~ I(lagpad(Gulf_Gasoline_log_ret, 1)), data = log_ret_dt)
res <- summary(model)$residuals
ar_lm_gulf_gas<- lm(res ~ lagpad(res, 1))
```

```{r gulf_gas_adf}
adf.test(log_ret_dt$Gulf_Gasoline_log_ret) # no unit root
```

```{r gulf_gas_res,echo=TRUE,results='asis'}
stargazer(ar_lm_gulf_gas, header=FALSE,type="html") #AR(1) OF RESIDUALS
```

```{r heating_oil,echo = F}
model <- lm(Heating_Oil_log_ret ~ I(lagpad(Heating_Oil_log_ret, 1)), data = log_ret_dt)
res <- summary(model)$residuals
ar_lm_heating_oil<- lm(res ~ lagpad(res, 1))
```

```{r heating_oil_adf}
adf.test(log_ret_dt$Heating_Oil_log_ret) # no unit root
```

```{r heating_oil_res,echo=TRUE,results='asis'}
stargazer(ar_lm_heating_oil, header=FALSE,type="html") #AR(1) OF RESIDUALS
```

```{r diesel,echo = F}
model <- lm(Diesel_log_ret ~ I(lagpad(Diesel_log_ret, 1)), data = log_ret_dt)
res <- summary(model)$residuals
ar_lm_diesel<- lm(res ~ lagpad(res, 1))
```

```{r diesel_adf}
adf.test(log_ret_dt$Diesel_log_ret) # no unit root
```

```{r diesel_res,echo=TRUE,results='asis'}
stargazer(ar_lm_diesel, header=FALSE,type="html")  #no autocorrelation of residuals
```

Few of these commodities have autocorrelation of residuals, which should be treated by FGLS or using robust standard errors.

## MA(1) Test
Only for Diesel since the others would be similar.
MA is obviously good fit since the data are already differenced (endogenously created)

```{r ma,echo = TRUE,results='asis'}
diesel_ma <- arima(log_ret_dt$Diesel_log_ret, order = c(0, 0, 1))
stargazer(diesel_ma, header=FALSE,type="html")
ts.plot(log_ret_dt$Diesel_log_ret)
points(log_ret_dt$Diesel_log_ret-diesel_ma$residuals, type = "l", col = 2, lty = 2)
```


```{r ar_differently,echo=TRUE,results='asis'}
ar<-arima(log_ret_dt$Diesel_log_ret, order = c(1, 0, 0))
stargazer(ar, header=FALSE,type="html")
```
Same as summary(model) from before, so I could also use this package for AR testing.
